name: Matrix Tor status

on:
  schedule:
    - cron: "*/8 * * * *"
  workflow_dispatch:

permissions:
  contents: write
  pages: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ─────────────────────────────────────────────
      # Checkout
      # ─────────────────────────────────────────────
      - name: Checkout
        uses: actions/checkout@v4

      # ─────────────────────────────────────────────
      # Restore previous raw.log
      # ─────────────────────────────────────────────
      - name: Download previous raw log (optional)
        uses: actions/download-artifact@v4
        with:
          name: raw-log
          path: logs
        continue-on-error: true

      # ─────────────────────────────────────────────
      # Install Tor + tools
      # ─────────────────────────────────────────────
      - name: Install Tor and tools
        run: |
          sudo apt-get update
          sudo apt-get install -y tor curl jq

      # ─────────────────────────────────────────────
      # Start Tor (2025 proof...)
      # ─────────────────────────────────────────────
      - name: Start Tor
        run: |
          set -e

          TOR_DATA="$PWD/tor-data"
          mkdir -p "$TOR_DATA"

          PORT=$((9050 + RANDOM % 1000))
          echo "$PORT" > tor-port.txt

          tor \
            --SocksPort "$PORT" \
            --DataDirectory "$TOR_DATA" \
            --Log "notice file tor.log" \
            --RunAsDaemon 1

          echo "Waiting for Tor bootstrap…"
          for i in {1..120}; do
            if grep -q "Bootstrapped 100%" tor.log; then
              echo "Tor bootstrapped"
              exit 0
            fi
            sleep 1
          done

          echo "::error::Tor failed to bootstrap"
          tail -n 50 tor.log || true
          exit 1

      # ─────────────────────────────────────────────
      # Probe Matrix homeserver via Tor
      # ─────────────────────────────────────────────
      - name: Probe Matrix over Tor
        env:
          MATRIX_ONION: ${{ secrets.MATRIX_ONION }}
        run: |
          set -e

          mkdir -p public logs

          if [ -z "$MATRIX_ONION" ]; then
            echo "::error::MATRIX_ONION secret not set"
            exit 1
          fi

          URL="${MATRIX_ONION%/}/_matrix/client/versions"
          PORT=$(cat tor-port.txt)

          STATUS="DOWN"
          LATENCY_MS=0

          START=$(date +%s%3N || true)

          HTTP_CODE=$(curl \
            --socks5-hostname 127.0.0.1:$PORT \
            --connect-timeout 10 \
            --max-time 20 \
            --retry 1 \
            -o /tmp/matrix.json \
            -w '%{http_code}' \
            "$URL" || echo 000)

          END=$(date +%s%3N || true)
          [ -n "$START" ] && [ -n "$END" ] && LATENCY_MS=$((END-START))

          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 500 ]; then
            if jq -e '.versions | type=="array"' /tmp/matrix.json >/dev/null 2>&1; then
              STATUS="UP"
            fi
          fi

          TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          jq -n \
            --arg status "$STATUS" \
            --argjson code "$HTTP_CODE" \
            --arg timestamp "$TS" \
            --argjson latency_ms "$LATENCY_MS" \
            '{status:$status, http_code:$code, checked_at:$timestamp, latency_ms:$latency_ms}' \
            > public/status.json

          echo "{\"status\":\"$STATUS\",\"http_code\":$HTTP_CODE,\"checked_at\":\"$TS\",\"latency_ms\":$LATENCY_MS}" >> logs/raw.log

      # ─────────────────────────────────────────────
      # Persist raw.log
      # ─────────────────────────────────────────────
      - name: Upload raw log artifact
        uses: actions/upload-artifact@v4
        with:
          name: raw-log
          path: logs/raw.log

      # ─────────────────────────────────────────────
      # Publish status.json
      # ─────────────────────────────────────────────
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
