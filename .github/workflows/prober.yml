name: Matrix Tor status

on:
  schedule:
    - cron: "*/7 * * * *"
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

concurrency:
  group: pages
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      # ─────────────────────────────────────────────
      # Checkout
      # ─────────────────────────────────────────────
      - name: Checkout
        uses: actions/checkout@v4

      # ─────────────────────────────────────────────
      # Install Tor + tools
      # ─────────────────────────────────────────────
      - name: Install Tor and tools
        run: |
          sudo apt-get update
          sudo apt-get install -y tor curl jq

      # ─────────────────────────────────────────────
      # Start Tor (foreground, reliable in Actions)
      # ─────────────────────────────────────────────
      - name: Start Tor
        run: |
          set -e

          TOR_DATA="$PWD/tor-data"
          mkdir -p "$TOR_DATA"

          PORT=$((9050 + RANDOM % 1000))
          echo "$PORT" > tor-port.txt

          # Run Tor in foreground and redirect logs
          tor --SocksPort "$PORT" \
              --DataDirectory "$TOR_DATA" \
              --Log "notice file tor.log" &
          
          echo "Waiting for Tor bootstrap…"
          for i in {1..300}; do
            if grep -q "Bootstrapped 100%" tor.log; then
              echo "Tor bootstrapped"
              break
            fi
            sleep 1
          done
          
          if ! grep -q "Bootstrapped 100%" tor.log; then
            echo "::warning::Tor did not fully bootstrap, continuing anyway"
          fi

      # ─────────────────────────────────────────────
      # Probe Matrix homeserver via Tor (2 retries)
      # ─────────────────────────────────────────────
      - name: Probe Matrix over Tor
        env:
          MATRIX_ONION: ${{ secrets.MATRIX_ONION }}
        run: |
          set -e
          mkdir -p public logs

          if [ -z "$MATRIX_ONION" ]; then
            echo "::error::MATRIX_ONION secret not set"
            exit 1
          fi

          URL="${MATRIX_ONION%/}/_matrix/client/versions"
          PORT=$(cat tor-port.txt)

          STATUS="DOWN"
          LATENCY_MS=0

          START=$(date +%s%3N || true)

          for TRY in 1 2; do
            HTTP_CODE=$(curl \
              --socks5-hostname 127.0.0.1:$PORT \
              --connect-timeout 30 \
              --max-time 60 \
              -o /tmp/matrix.json \
              -w '%{http_code}' \
              "$URL" || echo 000)

            END=$(date +%s%3N || true)
            LATENCY_MS=$((END-START))

            if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 500 ]; then
              if jq -e '.versions | type=="array"' /tmp/matrix.json >/dev/null 2>&1; then
                STATUS="UP"
                break
              fi
            fi

            sleep 5
          done

          TS=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

          jq -n \
            --arg status "$STATUS" \
            --argjson code "$HTTP_CODE" \
            --arg timestamp "$TS" \
            --argjson latency_ms "$LATENCY_MS" \
            '{status:$status, http_code:$code, checked_at:$timestamp, latency_ms:$latency_ms}' \
            > public/status.json

          echo "{\"status\":\"$STATUS\",\"http_code\":$HTTP_CODE,\"checked_at\":\"$TS\",\"latency_ms\":$LATENCY_MS}" >> logs/raw.log

      # ─────────────────────────────────────────────
      # Upload raw log (optional)
      # ─────────────────────────────────────────────
      - name: Upload raw log artifact
        uses: actions/upload-artifact@v4
        with:
          name: raw-log
          path: logs/raw.log

      # ─────────────────────────────────────────────
      # Publish status.json
      # ─────────────────────────────────────────────
      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: public

      - name: Deploy to GitHub Pages
        uses: actions/deploy-pages@v4
